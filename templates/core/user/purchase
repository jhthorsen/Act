<script type="text/javascript">
if (window.act) {
    var amounts = [% amounts %];
    $(function() {
        get_radios = function(product) { return $('[type="radio"][name="price-' + product +'"]') };
        compute_total = function() { 
            var total = 0;
            $('[type="checkbox"]:checked').each(function() {
                var product = $(this).val();
                if (amounts[product]) {
                  console.log(amounts[product]);
                    if (amounts[product].single)
                        total += parseInt(amounts[product][1]);
                    else
                        get_radios(product).filter("[checked]").each(function() {
                            var price_id = $(this).val();
                            if (amounts[product][price_id])
                                total += parseInt(amounts[product][price_id]);
                        });
                }
            });
            var donation = $("#form-donation").val();
            if (donation) {
                donation = parseInt(donation);
                if (donation > 0) total += donation;
            }
            console.log(total);
            $("#totalamount").text(total);
        };
        $(":checkbox").each(function() {
            var cb = $(this);
            var radios = get_radios(cb.val());
            // checking a price: check corresponding product checkbox
            radios.click(function() { cb.attr('checked',true); compute_total(); });
            // checking a product: check 1st price
            // unchecking a product: uncheck all its prices
            cb.click(function() {
                if (cb.attr('checked'))
                    radios.filter(':first').attr('checked',true);
                else
                    radios.attr('checked',false)
                compute_total();
            });
        });
        $("#form-donation").change(compute_total);
        compute_total();
        $("#total").attr('style', 'visibility: visible');
    });
}
</script>

<form method="POST" action="[% global.request.r.uri %]">
  <table class="table" id="act-purchase">
  [% FOREACH p IN productlist %]
    [% NEXT IF p == 'registration' AND global.request.user.has_paid %]
    <tr class="act-product">
      <td class="act-select text-right"><input type="checkbox" value="[% p %]" id="product-[% p %]" name="product-[% p %]"[% ' checked="checked"' IF products.$p.checked %] /></td>
      <td class="act-description"><label for="product-[% p %]">[% products.$p.name %]</label></td>
  [% IF products.$p.prices.size == 1 %]
      <td class="act-amount text-right">[% products.$p.prices.0.amount %]</td>
      <td class="act-currency">[% currency %]</td>
    </tr>
  [% ELSE %]
      <td></td>
      <td></td>
    </tr>

    [% ispromo = 0;
      FOREACH i IN products.$p.prices;
        UNLESS i.promocode AND ispromo %]
    <tr class="act-price">
      <td class="act-select"></td>
          [% IF i.promocode; ispromo = 1 %]
      <td class="act-description"><label for="promo-[% p %]">{{Promotion code}}</label></td>
      <td class="act-amount"><input type="text" id="promo-[% p %]" name="promo-[% p %]" size="20" maxlength="20" value="[% promo.$p %]" /></td>
          [% ELSE %]
      <td class="act-desciption"><input type="radio" id="price-[% p %]-[% i.price_id %]" name="price-[% p %]" value="[% i.price_id %]"[% ' checked="checked"' IF i.checked %] />
        <label for="price-[% p %]-[% i.price_id %]"> [% i.name %]
      </td>
      <td class="text-right act-amount">[% i.amount %]</td>
          [% END %]
      <td class="act-currency">[% currency %]</td>
    </tr>
        [% END %]
      [% END %]
    [% END %]
  [% END %]
    <tr class="act-donation">
      <td>&nbsp;</td>
      <td class="act-description">
        <label for="form-donation">{{Donation}}:</label>
      </td>
      <td class="act-amount text-right">
        <input name="donation" id="form-donation" type="text" size="5" maxlength="5" value="[% donation %]" />
      </td>
      <td class="act-currency">[% currency %]</td>
    </tr>
    <tr id="total" style="visibility: hidden">
      <td>&nbsp;</td>
      <td class="act-description"><strong>{{Total}}</strong></td>
      <td class="text-right act-amount"><strong><span id="totalamount">0</span></strong></td>
      <td class="act-currency">[% currency %]</td>
    </tr>
    <tr class="act-purchase-submit">
      <td colspan="3" class="text-right">
        <input type="submit" name="purchase" value="{{Buy now!}}" />
      </td>
      <td>&nbsp;</td>
    </tr>
  </table>
</form>

<p class="alert alert-warning">
 {{Please note that everything regarding your bank account and credit card number}}
</p>

[% file = "core/bank/${global.config.payment_type}" ; PROCESS $file %]
